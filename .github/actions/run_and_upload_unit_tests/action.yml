name: 'Run and upload unit tests'
description: 'Run unit tests using pytest and upload the results as an artifact.'
runs:
  using: "composite"
  steps:
    - name: Get OS version
      run: echo "osVersion=$ImageOS" >> "$GITHUB_ENV"
      shell: bash
    - name: Cache ni.datastore virtualenv
      uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5.0.3
      with:
        path: ./.venv
        key: ni.datastore-${{ runner.os }}-py${{ env.pythonVersion }}-${{ hashFiles('./poetry.lock') }}
    - name: Install ni.datastore
      run: poetry install -v
      working-directory: .
      shell: bash
    - name: Run ni.datastore unit tests and code coverage
      run: poetry run pytest ./tests/unit -v --cov=ni.datastore --junitxml=test_results/ni.datastore-${{ env.osVersion }}-py${{ env.pythonVersion }}.xml
      working-directory: .
      shell: bash
    - name: Upload ni.datastore test results
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
      with:
        name: test_results_unit_ni.datastore_${{ env.osVersion }}_py${{ env.pythonVersion }}
        path: ${{ github.workspace }}/test_results/*.xml
      if: always()